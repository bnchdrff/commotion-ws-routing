(function(){
/*!
Math.uuid.js (v1.4)
http://www.broofa.com
mailto:robert@broofa.com

Copyright (c) 2010 Robert Kieffer
Dual licensed under the MIT and GPL licenses.
*/
(function(){var CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(len,radix){var chars=CHARS,uuid=[];radix=radix||chars.length;if(len){for(var i=0;i<len;i++){uuid[i]=chars[0|Math.random()*radix]}}else{var r;uuid[8]=uuid[13]=uuid[18]=uuid[23]="-";uuid[14]="4";for(var i=0;i<36;i++){if(!uuid[i]){r=0|Math.random()*16;uuid[i]=chars[(i==19)?(r&3)|8:r]}}}return uuid.join("")};Math.uuidFast=function(){var chars=CHARS,uuid=new Array(36),rnd=0,r;for(var i=0;i<36;i++){if(i==8||i==13||i==18||i==23){uuid[i]="-"}else{if(i==14){uuid[i]="4"}else{if(rnd<=2){rnd=33554432+(Math.random()*16777216)|0}r=rnd&15;rnd=rnd>>4;uuid[i]=chars[(i==19)?(r&3)|8:r]}}}return uuid.join("")};Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)}).toUpperCase()}})();var Crypto={};(function(){Crypto.MD5=function(string){function RotateLeft(lValue,iShiftBits){return(lValue<<iShiftBits)|(lValue>>>(32-iShiftBits))}function AddUnsigned(lX,lY){var lX4,lY4,lX8,lY8,lResult;lX8=(lX&2147483648);lY8=(lY&2147483648);lX4=(lX&1073741824);lY4=(lY&1073741824);lResult=(lX&1073741823)+(lY&1073741823);if(lX4&lY4){return(lResult^2147483648^lX8^lY8)}if(lX4|lY4){if(lResult&1073741824){return(lResult^3221225472^lX8^lY8)}else{return(lResult^1073741824^lX8^lY8)}}else{return(lResult^lX8^lY8)}}function F(x,y,z){return(x&y)|((~x)&z)}function G(x,y,z){return(x&z)|(y&(~z))}function H(x,y,z){return(x^y^z)}function I(x,y,z){return(y^(x|(~z)))}function FF(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b)}function GG(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b)}function HH(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b)}function II(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b)}function ConvertToWordArray(string){var lWordCount;var lMessageLength=string.length;var lNumberOfWords_temp1=lMessageLength+8;var lNumberOfWords_temp2=(lNumberOfWords_temp1-(lNumberOfWords_temp1%64))/64;var lNumberOfWords=(lNumberOfWords_temp2+1)*16;var lWordArray=Array(lNumberOfWords-1);var lBytePosition=0;var lByteCount=0;while(lByteCount<lMessageLength){lWordCount=(lByteCount-(lByteCount%4))/4;lBytePosition=(lByteCount%4)*8;lWordArray[lWordCount]=(lWordArray[lWordCount]|(string.charCodeAt(lByteCount)<<lBytePosition));lByteCount++}lWordCount=(lByteCount-(lByteCount%4))/4;lBytePosition=(lByteCount%4)*8;lWordArray[lWordCount]=lWordArray[lWordCount]|(128<<lBytePosition);lWordArray[lNumberOfWords-2]=lMessageLength<<3;lWordArray[lNumberOfWords-1]=lMessageLength>>>29;return lWordArray}function WordToHex(lValue){var WordToHexValue="",WordToHexValue_temp="",lByte,lCount;for(lCount=0;lCount<=3;lCount++){lByte=(lValue>>>(lCount*8))&255;WordToHexValue_temp="0"+lByte.toString(16);WordToHexValue=WordToHexValue+WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2)}return WordToHexValue}var x=Array();var k,AA,BB,CC,DD,a,b,c,d;var S11=7,S12=12,S13=17,S14=22;var S21=5,S22=9,S23=14,S24=20;var S31=4,S32=11,S33=16,S34=23;var S41=6,S42=10,S43=15,S44=21;x=ConvertToWordArray(string);a=1732584193;b=4023233417;c=2562383102;d=271733878;for(k=0;k<x.length;k+=16){AA=a;BB=b;CC=c;DD=d;a=FF(a,b,c,d,x[k+0],S11,3614090360);d=FF(d,a,b,c,x[k+1],S12,3905402710);c=FF(c,d,a,b,x[k+2],S13,606105819);b=FF(b,c,d,a,x[k+3],S14,3250441966);a=FF(a,b,c,d,x[k+4],S11,4118548399);d=FF(d,a,b,c,x[k+5],S12,1200080426);c=FF(c,d,a,b,x[k+6],S13,2821735955);b=FF(b,c,d,a,x[k+7],S14,4249261313);a=FF(a,b,c,d,x[k+8],S11,1770035416);d=FF(d,a,b,c,x[k+9],S12,2336552879);c=FF(c,d,a,b,x[k+10],S13,4294925233);b=FF(b,c,d,a,x[k+11],S14,2304563134);a=FF(a,b,c,d,x[k+12],S11,1804603682);d=FF(d,a,b,c,x[k+13],S12,4254626195);c=FF(c,d,a,b,x[k+14],S13,2792965006);b=FF(b,c,d,a,x[k+15],S14,1236535329);a=GG(a,b,c,d,x[k+1],S21,4129170786);d=GG(d,a,b,c,x[k+6],S22,3225465664);c=GG(c,d,a,b,x[k+11],S23,643717713);b=GG(b,c,d,a,x[k+0],S24,3921069994);a=GG(a,b,c,d,x[k+5],S21,3593408605);d=GG(d,a,b,c,x[k+10],S22,38016083);c=GG(c,d,a,b,x[k+15],S23,3634488961);b=GG(b,c,d,a,x[k+4],S24,3889429448);a=GG(a,b,c,d,x[k+9],S21,568446438);d=GG(d,a,b,c,x[k+14],S22,3275163606);c=GG(c,d,a,b,x[k+3],S23,4107603335);b=GG(b,c,d,a,x[k+8],S24,1163531501);a=GG(a,b,c,d,x[k+13],S21,2850285829);d=GG(d,a,b,c,x[k+2],S22,4243563512);c=GG(c,d,a,b,x[k+7],S23,1735328473);b=GG(b,c,d,a,x[k+12],S24,2368359562);a=HH(a,b,c,d,x[k+5],S31,4294588738);d=HH(d,a,b,c,x[k+8],S32,2272392833);c=HH(c,d,a,b,x[k+11],S33,1839030562);b=HH(b,c,d,a,x[k+14],S34,4259657740);a=HH(a,b,c,d,x[k+1],S31,2763975236);d=HH(d,a,b,c,x[k+4],S32,1272893353);c=HH(c,d,a,b,x[k+7],S33,4139469664);b=HH(b,c,d,a,x[k+10],S34,3200236656);a=HH(a,b,c,d,x[k+13],S31,681279174);d=HH(d,a,b,c,x[k+0],S32,3936430074);c=HH(c,d,a,b,x[k+3],S33,3572445317);b=HH(b,c,d,a,x[k+6],S34,76029189);a=HH(a,b,c,d,x[k+9],S31,3654602809);d=HH(d,a,b,c,x[k+12],S32,3873151461);c=HH(c,d,a,b,x[k+15],S33,530742520);b=HH(b,c,d,a,x[k+2],S34,3299628645);a=II(a,b,c,d,x[k+0],S41,4096336452);d=II(d,a,b,c,x[k+7],S42,1126891415);c=II(c,d,a,b,x[k+14],S43,2878612391);b=II(b,c,d,a,x[k+5],S44,4237533241);a=II(a,b,c,d,x[k+12],S41,1700485571);d=II(d,a,b,c,x[k+3],S42,2399980690);c=II(c,d,a,b,x[k+10],S43,4293915773);b=II(b,c,d,a,x[k+1],S44,2240044497);a=II(a,b,c,d,x[k+8],S41,1873313359);d=II(d,a,b,c,x[k+15],S42,4264355552);c=II(c,d,a,b,x[k+6],S43,2734768916);b=II(b,c,d,a,x[k+13],S44,1309151649);a=II(a,b,c,d,x[k+4],S41,4149444226);d=II(d,a,b,c,x[k+11],S42,3174756917);c=II(c,d,a,b,x[k+2],S43,718787259);b=II(b,c,d,a,x[k+9],S44,3951481745);a=AddUnsigned(a,AA);b=AddUnsigned(b,BB);c=AddUnsigned(c,CC);d=AddUnsigned(d,DD)}var temp=WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);return temp.toLowerCase()}})();this.Pouch=function Pouch(name,opts,callback){if(!(this instanceof Pouch)){return new Pouch(name,opts,callback)}if(opts instanceof Function||typeof opts==="undefined"){callback=opts;opts={}}var backend=Pouch.parseAdapter(opts.name||name);opts.name=backend.name;opts.adapter=opts.adapter||backend.adapter;if(!Pouch.adapters[backend.adapter]){throw"Adapter is missing"}if(!Pouch.adapters[backend.adapter].valid()){throw"Invalid Adapter"}var adapter=Pouch.adapters[backend.adapter](opts,callback);for(var j in adapter){this[j]=adapter[j]}};Pouch.parseAdapter=function(name){var match=name.match(/([a-z\-]*):\/\/(.*)/);if(match){name=/http(s?)/.test(match[1])?match[1]+"://"+match[2]:match[2];var adapter=match[1];if(!Pouch.adapters[adapter].valid()){throw"Invalid adapter"}return{name:name,adapter:match[1]}}for(var i in Pouch.adapters){if(Pouch.adapters[i].valid()){return{name:name,adapter:i}}}throw"No Valid Adapter."};Pouch.destroy=function(name,callback){var opts=Pouch.parseAdapter(name);Pouch.adapters[opts.adapter].destroy(opts.name,callback)};Pouch.adapters={};Pouch.adapter=function(id,obj){Pouch.adapters[id]=obj};Pouch.Errors={MISSING_BULK_DOCS:{status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"},MISSING_DOC:{status:404,error:"not_found",reason:"missing"},REV_CONFLICT:{status:409,error:"conflict",reason:"Document update conflict"},INVALID_ID:{status:400,error:"invalid_id",reason:"_id field must contain a string"},UNKNOWN_ERROR:{status:500,error:"unknown_error",reason:"Database encountered an unknown error"}};(function(){Pouch.collate=function(a,b){var ai=collationIndex(a);var bi=collationIndex(b);if((ai-bi)!==0){return ai-bi}if(a===null){return 0}if(typeof a==="number"){return a-b}if(typeof a==="boolean"){return a<b?-1:1}if(typeof a==="string"){return stringCollate(a,b)}if(Array.isArray(a)){return arrayCollate(a,b)}if(typeof a==="object"){return objectCollate(a,b)}};var stringCollate=function(a,b){return(a===b)?0:((a>b)?1:-1)};var objectCollate=function(a,b){var ak=Object.keys(a),bk=Object.keys(b);var len=Math.min(ak.length,bk.length);for(var i=0;i<len;i++){var sort=Pouch.collate(ak[i],bk[i]);if(sort!==0){return sort}sort=Pouch.collate(a[ak[i]],b[bk[i]]);if(sort!==0){return sort}}return(ak.length===bk.length)?0:(ak.length>bk.length)?1:-1};var arrayCollate=function(a,b){var len=Math.min(a.length,b.length);for(var i=0;i<len;i++){var sort=Pouch.collate(a[i],b[i]);if(sort!==0){return sort}}return(a.length===b.length)?0:(a.length>b.length)?1:-1};var collationIndex=function(x){var id=["boolean","number","string","object"];if(id.indexOf(typeof x)!==-1){if(x===null){return 1}return id.indexOf(typeof x)+2}if(Array.isArray(x)){return 4.5}}}).call(this);(function(){function pathToTree(path){var root=[path.shift(),[]];var leaf=root;while(path.length){nleaf=[path.shift(),[]];leaf[1].push(nleaf);leaf=nleaf}return root}function stem(tree,depth){var stemmedPaths=rootToLeaf(tree).map(function(path){var stemmed=path.ids.slice(-depth);return{pos:path.pos+(path.ids.length-stemmed.length),ids:pathToTree(stemmed)}});return stemmedPaths.reduce(function(prev,current,i,arr){return doMerge(prev,current,true).tree},[stemmedPaths.shift()])}function mergeTree(tree1,tree2){var conflicts=false;for(var i=0;i<tree2[1].length;i++){if(!tree1[1][0]){conflicts="new_leaf";tree1[1][0]=tree2[1][i]}if(tree1[1][0].indexOf(tree2[1][i][0])===-1){conflicts="new_branch";tree1[1].push(tree2[1][i]);tree1[1].sort()}else{var result=mergeTree(tree1[1][0],tree2[1][i]);conflicts=result.conflicts||conflicts;tree1[1][0]=result.tree}}return{conflicts:conflicts,tree:tree1}}function doMerge(tree,path,dontExpand){var restree=[];var conflicts=false;var merged=false;var res,branch;if(!tree.length){return{tree:[path],conflicts:"new_leaf"}}tree.forEach(function(branch){if(branch.pos===path.pos&&branch.ids[0]===path.ids[0]){res=mergeTree(branch.ids,path.ids);restree.push({pos:branch.pos,ids:res.tree});conflicts=conflicts||res.conflicts;merged=true}else{if(dontExpand!==true){var t1=branch.pos<path.pos?branch:path;var t2=branch.pos<path.pos?path:branch;var diff=t2.pos-t1.pos;var parent,tmp=t1.ids;while(diff--){parent=tmp[1];tmp=tmp[1][0]}if(tmp[0]!==t2.ids[0]){restree.push(branch)}else{res=mergeTree(tmp,t2.ids);parent[0]=res.tree;restree.push({pos:t1.pos,ids:t1.ids});conflicts=conflicts||res.conflicts;merged=true}}else{restree.push(branch)}}});if(!merged){restree.push(path)}restree.sort(function(a,b){return a.pos-b.pos});return{tree:restree,conflicts:conflicts||"internal_node"}}Pouch.merge=function(tree,path,depth){tree=JSON.parse(JSON.stringify(tree));path=JSON.parse(JSON.stringify(path));var newTree=doMerge(tree,path);return{tree:stem(newTree.tree,depth),conflicts:newTree.conflicts}}}).call(this);(function(){function replicate(src,target,opts,callback,replicateRet){fetchCheckpoint(src,target,function(checkpoint){var results=[];var completed=false;var pending=0;var last_seq=0;var continuous=opts.continuous||false;var result={ok:true,start_time:new Date(),docs_read:0,docs_written:0};function isCompleted(){if(completed&&pending===0){result.end_time=new Date();writeCheckpoint(src,target,last_seq,function(){call(callback,null,result)})}}if(replicateRet.cancelled){return}var repOpts={continuous:continuous,since:checkpoint,onChange:function(change){last_seq=change.seq;results.push(change);result.docs_read++;pending++;var diff={};diff[change.id]=change.changes.map(function(x){return x.rev});target.revsDiff(diff,function(err,diffs){if(Object.keys(diffs).length===0){pending--;isCompleted();return}for(var id in diffs){diffs[id].missing.map(function(rev){src.get(id,{revs:true,rev:rev,attachments:true},function(err,doc){target.bulkDocs({docs:[doc]},{new_edits:false},function(){if(opts.onChange){opts.onChange.apply(this,[result])}result.docs_written++;pending--;isCompleted()})})})}})},complete:function(err,res){completed=true;isCompleted()}};if(opts.filter){repOpts.filter=opts.filter}var changes=src.changes(repOpts);if(opts.continuous){replicateRet.cancel=changes.cancel}})}function toPouch(db,callback){if(typeof db==="string"){return new Pouch(db,callback)}callback(null,db)}Pouch.replicate=function(src,target,opts,callback){var ret=function(){this.cancelled=false;this.cancel=function(){this.cancelled=true}};var replicateRet=new ret();toPouch(src,function(_,src){toPouch(target,function(_,target){replicate(src,target,opts,callback,replicateRet)})});return replicateRet}}).call(this);var call=function(fun){var args=Array.prototype.slice.call(arguments,1);if(typeof fun===typeof Function){fun.apply(this,args)}};var parseDoc=function(doc,newEdits){var error=null;if(newEdits){if(!doc._id){doc._id=Math.uuid()}var newRevId=Math.uuid(32,16).toLowerCase();var nRevNum;if(doc._rev){var revInfo=/^(\d+)-(.+)$/.exec(doc._rev);if(!revInfo){throw"invalid value for property '_rev'"}doc._rev_tree=[{pos:parseInt(revInfo[1],10),ids:[revInfo[2],[[newRevId,[]]]]}];nRevNum=parseInt(revInfo[1],10)+1}else{doc._rev_tree=[{pos:1,ids:[newRevId,[]]}];nRevNum=1}}else{if(doc._revisions){doc._rev_tree=[{pos:doc._revisions.start-doc._revisions.ids.length+1,ids:doc._revisions.ids.reduce(function(acc,x){if(acc===null){return[x,[]]}else{return[x,[acc]]}},null)}]}if(!doc._rev_tree){var revInfo=/^(\d+)-(.+)$/.exec(doc._rev);nRevNum=parseInt(revInfo[1],10);newRevId=revInfo[2];doc._rev_tree=[{pos:parseInt(revInfo[1],10),ids:[revInfo[2],[]]}]}}if(typeof doc._id!=="string"){error=Pouch.Errors.INVALID_ID}doc._id=decodeURIComponent(doc._id);doc._rev=[nRevNum,newRevId].join("-");if(error){return error}return Object.keys(doc).reduce(function(acc,key){if(/^_/.test(key)&&key!=="_attachments"){acc.metadata[key.slice(1)]=doc[key]}else{acc.data[key]=doc[key]}return acc},{metadata:{},data:{}})};var compareRevs=function(a,b){if(a.id!==b.id){return(a.id<b.id?-1:1)}if(a.deleted^b.deleted){return(a.deleted?-1:1)}if(a.rev_tree[0].pos===b.rev_tree[0].pos){return(a.rev_tree[0].ids<b.rev_tree[0].ids?-1:1)}return(a.rev_tree[0].start<b.rev_tree[0].start?-1:1)};var expandTree=function(all,i,tree){all.push({rev:i+"-"+tree[0],status:"available"});tree[1].forEach(function(child){expandTree(all,i+1,child)})};var collectRevs=function(path){var revs=[];expandTree(revs,path.pos,path.ids);return revs};var collectLeavesInner=function(all,pos,tree){if(!tree[1].length){all.push({rev:pos+"-"+tree[0]})}tree[1].forEach(function(child){collectLeavesInner(all,pos+1,child)})};var collectLeaves=function(revs){var leaves=[];revs.forEach(function(tree){collectLeavesInner(leaves,tree.pos,tree.ids)});return leaves};var collectConflicts=function(revs){var leaves=collectLeaves(revs);leaves.shift();return leaves.map(function(x){return x.rev})};var fetchCheckpoint=function(src,target,callback){var id=Crypto.MD5(src.id()+target.id());src.get("_local/"+id,function(err,doc){if(err&&err.status===404){callback(0)}else{callback(doc.last_seq)}})};var writeCheckpoint=function(src,target,checkpoint,callback){var check={_id:"_local/"+Crypto.MD5(src.id()+target.id()),last_seq:checkpoint};src.get(check._id,function(err,doc){if(doc&&doc._rev){check._rev=doc._rev}src.put(check,function(err,doc){callback()})})};function expandTree2(all,current,pos,arr){current=current.slice(0);current.push(arr[0]);if(!arr[1].length){all.push({pos:pos,ids:current})}arr[1].forEach(function(child){expandTree2(all,current,pos,child)})}function rootToLeaf(tree){var all=[];tree.forEach(function(path){expandTree2(all,[],path.pos,path.ids)});return all}var arrayFirst=function(arr,callback){for(var i=0;i<arr.length;i++){if(callback(arr[i],i)===true){return arr[i]}}return false};var localJSON=(function(){if(!localStorage){return false}return{set:function(prop,val){localStorage.setItem(prop,JSON.stringify(val))},get:function(prop,def){try{if(localStorage.getItem(prop)===null){return def}return JSON.parse((localStorage.getItem(prop)||"false"))}catch(err){return def}},remove:function(prop){localStorage.removeItem(prop)}}})();function parseUri(str){var o=parseUri.options;var m=o.parser[o.strictMode?"strict":"loose"].exec(str);var uri={};var i=14;while(i--){uri[o.key[i]]=m[i]||""}uri[o.q.name]={};uri[o.key[12]].replace(o.q.parser,function($0,$1,$2){if($1){uri[o.q.name][$1]=$2}});return uri}parseUri.options={strictMode:false,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};function getHost(name){if(/http(s?):/.test(name)){var uri=parseUri(name);uri.remote=true;uri.auth={username:uri.user,password:uri.password};var parts=uri.path.replace(/(^\/|\/$)/g,"").split("/");uri.db=parts.pop();uri.path=parts.join("/");return uri}return{host:"",path:"/",db:name,auth:false}}function genUrl(opts,path){if(opts.remote){var pathDel=!opts.path?"":"/";return opts.protocol+"://"+opts.host+":"+opts.port+"/"+opts.path+pathDel+opts.db+"/"+path}return"/"+opts.db+"/"+path}function ajax(options,callback){var defaults={success:function(obj,_,xhr){call(callback,null,obj,xhr)},error:function(err){if(err){var errObj={status:err.status};try{errObj=$.extend({},errObj,JSON.parse(err.responseText))}catch(e){}call(callback,errObj)}else{call(callback,true)}},headers:{Accept:"application/json"},dataType:"json",contentType:"application/json"};options=$.extend({},defaults,options);if(options.data&&typeof options.data!=="string"){options.data=JSON.stringify(options.data)}if(options.auth){options.beforeSend=function(xhr){var token=btoa(options.auth.username+":"+options.auth.password);xhr.setRequestHeader("Authorization","Basic "+token)}}return $.ajax(options)}var HttpPouch=function(opts,callback){var host=getHost(opts.name);var db_url=genUrl(host,"");var api={};ajax({auth:host.auth,type:"PUT",url:db_url},function(err,ret){if(err&&err.status===401){ajax({auth:host.auth,type:"HEAD",url:db_url},function(err,ret){if(err){call(callback,err)}else{call(callback,null,api)}})}else{if(!err||err.status===412){call(callback,null,api)}else{call(callback,Pouch.Errors.UNKNOWN_ERROR)}}});api.id=function(){return genUrl(host,"")};api.info=function(callback){ajax({auth:host.auth,type:"GET",url:genUrl(host,""),},callback)};api.get=function(id,opts,callback){if(opts instanceof Function){callback=opts;opts={}}var params=[];if(opts.revs){params.push("revs=true")}if(opts.revs_info){params.push("revs_info=true")}if(opts.attachments){params.push("attachments=true")}if(opts.rev){params.push("rev="+opts.rev)}if(opts.conflicts){params.push("conflicts="+opts.conflicts)}params=params.join("&");params=params===""?"":"?"+params;var options={auth:host.auth,type:"GET",url:genUrl(host,id+params)};var parts=id.split("/");if((parts.length>1&&parts[0]!=="_design"&&parts[0]!=="_local")||(parts.length>2&&parts[0]==="_design"&&parts[0]!=="_local")){options.dataType=false}ajax(options,function(err,doc,xhr){if(err){return call(callback,Pouch.Errors.MISSING_DOC)}call(callback,null,doc,xhr)})};api.query=function(fun,opts,callback){if(opts instanceof Function){callback=opts;opts={}}var params=[];if(typeof opts.reduce!=="undefined"){params.push("reduce="+opts.reduce)}params=params.join("&");params=params===""?"":"?"+params;var parts=fun.split("/");ajax({auth:host.auth,type:"GET",url:genUrl(host,"_design/"+parts[0]+"/_view/"+parts[1]+params),},callback)};api.remove=function(doc,opts,callback){if(opts instanceof Function){callback=opts;opts={}}ajax({auth:host.auth,type:"DELETE",url:genUrl(host,doc._id)+"?rev="+doc._rev},callback)};api.putAttachment=function(id,rev,doc,type,callback){ajax({auth:host.auth,type:"PUT",url:genUrl(host,id)+"?rev="+rev,headers:{"Content-Type":type},data:doc},callback)};api.put=function(doc,opts,callback){if(opts instanceof Function){callback=opts;opts={}}var params=[];if(opts&&typeof opts.new_edits!=="undefined"){params.push("new_edits="+opts.new_edits)}params=params.join("&");if(params!==""){params="?"+params}ajax({auth:host.auth,type:"PUT",url:genUrl(host,doc._id)+params,data:doc},callback)};api.post=function(doc,opts,callback){if(opts instanceof Function){callback=opts;opts={}}ajax({auth:host.auth,type:"POST",url:genUrl(host,""),data:doc},callback)};api.bulkDocs=function(req,opts,callback){if(opts instanceof Function){callback=opts;opts={}}if(typeof opts.new_edits!=="undefined"){req.new_edits=opts.new_edits}ajax({auth:host.auth,type:"POST",url:genUrl(host,"_bulk_docs"),data:req},callback)};api.allDocs=function(opts,callback){if(opts instanceof Function){callback=opts;opts={}}var params=[];if(opts.conflicts){params.push("conflicts=true")}if(opts.include_docs){params.push("include_docs=true")}if(opts.startkey){params.push("startkey="+encodeURIComponent(JSON.stringify(opts.startkey)))}if(opts.endkey){params.push("endkey="+encodeURIComponent(JSON.stringify(opts.endkey)))}params=params.join("&");if(params!==""){params="?"+params}ajax({auth:host.auth,type:"GET",url:genUrl(host,"_all_docs"+params)},callback)};api.changes=function(opts,callback){if(opts instanceof Function){opts={complete:opts}}if(callback){opts.complete=callback}console.info(db_url+": Start Changes Feed: continuous="+opts.continuous);var params="?style=all_docs";if(opts.include_docs||opts.filter&&typeof opts.filter==="function"){params+="&include_docs=true"}if(opts.continuous){params+="&feed=longpoll"}if(opts.conflicts){params+="&conflicts=true"}if(opts.descending){params+="&descending=true"}if(opts.filter&&typeof opts.filter==="string"){params+="&filter="+opts.filter}var xhr;var fetch=function(since,callback){var xhrOpts={auth:host.auth,type:"GET",url:genUrl(host,"_changes"+params+"&since="+since)};if(opts.aborted){return}xhr=ajax(xhrOpts,function(err,res){callback(res)})};var fetched=function(res){if(res&&res.results){res.results.forEach(function(c){var hasFilter=opts.filter&&typeof opts.filter==="function";if(opts.aborted||hasFilter&&!opts.filter.apply(this,[c.doc])){return}call(opts.onChange,c)})}if(res&&opts.continuous){fetch(res.last_seq,fetched)}else{call(opts.complete,null,res)}};fetch(opts.since||0,fetched);return{cancel:function(){console.info(db_url+": Cancel Changes Feed");opts.aborted=true;xhr.abort()}}};api.revsDiff=function(req,opts,callback){if(opts instanceof Function){callback=opts;opts={}}ajax({auth:host.auth,type:"POST",url:genUrl(host,"_revs_diff"),data:req},function(err,res){call(callback,null,res)})};api.replicate={};api.replicate.from=function(url,opts,callback){if(opts instanceof Function){callback=opts;opts={}}return Pouch.replicate(url,api,opts,callback)};api.replicate.to=function(dbName,opts,callback){if(opts instanceof Function){callback=opts;opts={}}return Pouch.replicate(api,dbName,opts,callback)};return api};HttpPouch.destroy=function(name,callback){var host=getHost(name);ajax({auth:host.auth,type:"DELETE",url:genUrl(host,"")},callback)};HttpPouch.valid=function(){return true};Pouch.adapter("http",HttpPouch);Pouch.adapter("https",HttpPouch);window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB;window.IDBCursor=window.IDBCursor||window.webkitIDBCursor;window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction;IDBTransaction=IDBTransaction||{};IDBTransaction.READ_WRITE=IDBTransaction.READ_WRITE||"readwrite";IDBTransaction.READ=IDBTransaction.READ||"readonly";IDBCursor=IDBCursor||{};IDBCursor.NEXT=IDBCursor.NEXT||"next";IDBCursor.PREV=IDBCursor.PREV||"prev";var idbError=function(callback){return function(event){call(callback,{status:500,error:event.type,reason:event.target})}};var IdbPouch=function(opts,callback){var POUCH_VERSION=1;var DOC_STORE="document-store";var BY_SEQ_STORE="by-sequence";var ATTACH_STORE="attach-store";var name=opts.name;var req=indexedDB.open(name,POUCH_VERSION);var update_seq=0;var api={};var idb;console.info(name+": Open Database");req.onupgradeneeded=function(e){var db=e.target.result;db.createObjectStore(DOC_STORE,{keyPath:"id"}).createIndex("seq","seq",{unique:true});db.createObjectStore(BY_SEQ_STORE,{autoIncrement:true});db.createObjectStore(ATTACH_STORE,{keyPath:"digest"})};req.onsuccess=function(e){idb=e.target.result;idb.onversionchange=function(){idb.close()};if(idb.setVersion&&Number(idb.version)!==POUCH_VERSION){var versionReq=idb.setVersion(POUCH_VERSION);versionReq.onsuccess=function(evt){function setVersionComplete(){req.onsuccess(e)}evt.target.result.oncomplete=setVersionComplete;req.onupgradeneeded(e)};return}api.changes(function(err,changes){if(changes.results.length){update_seq=changes.results[changes.results.length-1].seq}call(callback,null,api)})};req.onerror=idbError(callback);api.id=function idb_id(){var id=localJSON.get(name+"_id",null);if(id===null){id=Math.uuid();localJSON.set(name+"_id",id)}return id};api.bulkDocs=function idb_bulkDocs(req,opts,callback){if(opts instanceof Function){callback=opts;opts={}}if(!opts){opts={}}if(!req.docs){return call(callback,Pouch.Errors.MISSING_BULK_DOCS)}var newEdits="new_edits" in opts?opts.new_edits:true;var userDocs=JSON.parse(JSON.stringify(req.docs));var docInfos=userDocs.map(function(doc,i){var newDoc=parseDoc(doc,newEdits);newDoc._bulk_seq=i;return newDoc});var results=[];var docs=[];docInfos.forEach(function(docInfo){if(docInfo.error){return results.push(docInfo)}if(!docs.length||docInfo.metadata.id!==docs[0].metadata.id){return docs.unshift(docInfo)}results.push(makeErr(Pouch.Errors.REV_CONFLICT,docInfo._bulk_seq))});var txn=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],IDBTransaction.READ_WRITE);txn.onerror=idbError(callback);txn.ontimeout=idbError(callback);processDocs();function processDocs(){if(!docs.length){return complete()}var currentDoc=docs.shift();var req=txn.objectStore(DOC_STORE).get(currentDoc.metadata.id);req.onsuccess=function process_docRead(event){var oldDoc=event.target.result;if(!oldDoc){insertDoc(currentDoc,processDocs)}else{updateDoc(oldDoc,currentDoc)}}}function complete(event){var aresults=[];results.sort(sortByBulkSeq);results.forEach(function(result){delete result._bulk_seq;if(result.error){aresults.push(result);return}var metadata=result.metadata;var rev=winningRev(metadata.rev_tree[0].pos,metadata.rev_tree[0].ids);aresults.push({ok:true,id:metadata.id,rev:rev,});if(/_local/.test(metadata.id)){return}var change={id:metadata.id,seq:metadata.seq,changes:collectLeaves(metadata.rev_tree),doc:result.data};change.doc._rev=rev;update_seq++;IdbPouch.Changes.emitChange(name,change)});call(callback,null,aresults)}function writeDoc(docInfo,callback){for(var key in docInfo.data._attachments){if(!docInfo.data._attachments[key].stub){var data=docInfo.data._attachments[key].data;var digest="md5-"+Crypto.MD5(data);delete docInfo.data._attachments[key].data;docInfo.data._attachments[key].digest=digest;saveAttachment(digest,data)}}docInfo.data._id=docInfo.metadata.id;if(docInfo.metadata.deleted){docInfo.data._deleted=true}var dataReq=txn.objectStore(BY_SEQ_STORE).put(docInfo.data);dataReq.onsuccess=function(e){console.info(name+": Wrote Document ",docInfo.metadata.id);docInfo.metadata.seq=e.target.result;delete docInfo.metadata.rev;var metaDataReq=txn.objectStore(DOC_STORE).put(docInfo.metadata);metaDataReq.onsuccess=function(){results.push(docInfo);call(callback)}}}function updateDoc(oldDoc,docInfo){var merged=Pouch.merge(oldDoc.rev_tree,docInfo.metadata.rev_tree[0],1000);var inConflict=(oldDoc.deleted&&docInfo.metadata.deleted)||(!oldDoc.deleted&&newEdits&&merged.conflicts!=="new_leaf");if(inConflict){results.push(makeErr(Pouch.Errors.REV_CONFLICT,docInfo._bulk_seq));return processDocs()}docInfo.metadata.rev_tree=merged.tree;writeDoc(docInfo,processDocs)}function insertDoc(docInfo){if("was_delete" in opts&&docInfo.metadata.deleted){results.push(Pouch.Errors.MISSING_DOC);return processDocs()}writeDoc(docInfo,processDocs)}function makeErr(err,seq){err._bulk_seq=seq;return err}function saveAttachment(digest,data){txn.objectStore(ATTACH_STORE).put({digest:digest,body:data})}};function sortByBulkSeq(a,b){return a._bulk_seq-b._bulk_seq}api.get=function idb_get(id,opts,callback){if(opts instanceof Function){callback=opts;opts={}}var txn=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],IDBTransaction.READ);if(/\//.test(id)&&!/^_local/.test(id)&&!/^_design/.test(id)){var docId=id.split("/")[0];var attachId=id.split("/")[1];txn.objectStore(DOC_STORE).get(docId).onsuccess=function(e){var metadata=e.target.result;var bySeq=txn.objectStore(BY_SEQ_STORE);bySeq.get(metadata.seq).onsuccess=function(e){var digest=e.target.result._attachments[attachId].digest;txn.objectStore(ATTACH_STORE).get(digest).onsuccess=function(e){call(callback,null,atob(e.target.result.body))}}};return}txn.objectStore(DOC_STORE).get(id).onsuccess=function(e){var metadata=e.target.result;if(!e.target.result||(metadata.deleted&&!opts.rev)){return call(callback,Pouch.Errors.MISSING_DOC)}txn.objectStore(BY_SEQ_STORE).get(metadata.seq).onsuccess=function(e){var doc=e.target.result;doc._id=metadata.id;doc._rev=winningRev(metadata.rev_tree[0].pos,metadata.rev_tree[0].ids);if(opts.revs){var path=arrayFirst(rootToLeaf(metadata.rev_tree),function(arr){return arr.ids.indexOf(doc._rev.split("-")[1])!==-1});path.ids.reverse();doc._revisions={start:(path.pos+path.ids.length)-1,ids:path.ids}}if(opts.revs_info){doc._revs_info=metadata.rev_tree.reduce(function(prev,current){return prev.concat(collectRevs(current))},[])}if(opts.conflicts){var conflicts=collectConflicts(metadata.rev_tree);if(conflicts.length){doc._conflicts=conflicts}}if(opts.attachments&&doc._attachments){var attachments=Object.keys(doc._attachments);var recv=0;attachments.forEach(function(key){api.get(doc._id+"/"+key,function(err,data){doc._attachments[key].data=btoa(data);if(++recv===attachments.length){callback(null,doc)}})})}else{callback(null,doc)}}}};api.put=api.post=function idb_put(doc,opts,callback){if(opts instanceof Function){callback=opts;opts={}}return api.bulkDocs({docs:[doc]},opts,yankError(callback))};api.remove=function idb_remove(doc,opts,callback){if(opts instanceof Function){callback=opts;opts={}}opts.was_delete=true;var newDoc=JSON.parse(JSON.stringify(doc));newDoc._deleted=true;return api.bulkDocs({docs:[newDoc]},opts,yankError(callback))};api.allDocs=function idb_allDocs(opts,callback){if(opts instanceof Function){callback=opts;opts={}}var start="startkey" in opts?opts.startkey:false;var end="endkey" in opts?opts.endkey:false;var descending="descending" in opts?opts.descending:false;descending=descending?IDBCursor.PREV:null;var keyRange=start&&end?IDBKeyRange.bound(start,end,false,false):start?IDBKeyRange.lowerBound(start,true):end?IDBKeyRange.upperBound(end):false;var transaction=idb.transaction([DOC_STORE,BY_SEQ_STORE],IDBTransaction.READ);keyRange=keyRange||null;var oStore=transaction.objectStore(DOC_STORE);var oCursor=descending?oStore.openCursor(keyRange,descending):oStore.openCursor(keyRange);var results=[];oCursor.onsuccess=function(e){if(!e.target.result){return callback(null,{total_rows:results.length,rows:results})}var cursor=e.target.result;function allDocsInner(metadata,data){if(/_local/.test(metadata.id)){return cursor["continue"]()}if(metadata.deleted!==true){var doc={id:metadata.id,key:metadata.id,value:{rev:winningRev(metadata.rev_tree[0].pos,metadata.rev_tree[0].ids)}};if(opts.include_docs){doc.doc=data;doc.doc._rev=winningRev(metadata.rev_tree[0].pos,metadata.rev_tree[0].ids);if(opts.conflicts){doc.doc._conflicts=collectConflicts(metadata.rev_tree)}}results.push(doc)}cursor["continue"]()}if(!opts.include_docs){allDocsInner(cursor.value)}else{var index=transaction.objectStore(BY_SEQ_STORE);index.get(cursor.value.seq).onsuccess=function(event){allDocsInner(cursor.value,event.target.result)}}}};api.info=function idb_info(callback){var count=0;idb.transaction([DOC_STORE],IDBTransaction.READ).objectStore(DOC_STORE).openCursor().onsuccess=function(e){var cursor=e.target.result;if(!cursor){return callback(null,{db_name:name,doc_count:count,update_seq:update_seq})}if(cursor.value.deleted!==true){count++}cursor["continue"]()}};api.putAttachment=function idb_putAttachment(id,rev,doc,type,callback){var docId=id.split("/")[0];var attachId=id.split("/")[1];api.get(docId,{attachments:true},function(err,obj){obj._attachments||(obj._attachments={});obj._attachments[attachId]={content_type:type,data:btoa(doc)};api.put(obj,callback)})};api.revsDiff=function idb_revsDiff(req,opts,callback){if(opts instanceof Function){callback=opts;opts={}}var ids=Object.keys(req);var count=0;var missing={};function readDoc(err,doc,id){req[id].map(function(revId){var matches=function(x){return x.rev!==revId};if(!doc||doc._revs_info.every(matches)){if(!missing[id]){missing[id]={missing:[]}}missing[id].missing.push(revId)}});if(++count===ids.length){return call(callback,null,missing)}}ids.map(function(id){api.get(id,{revs_info:true},function(err,doc){readDoc(err,doc,id)})})};api.changes=function idb_changes(opts,callback){if(opts instanceof Function){opts={complete:opts}}if(callback){opts.complete=callback}if(!opts.seq){opts.seq=0}if(opts.since){opts.seq=opts.since}console.info(name+": Start Changes Feed: continuous="+opts.continuous);var descending="descending" in opts?opts.descending:false;descending=descending?IDBCursor.PREV:null;var results=[];var id=name+":"+Math.uuid();var txn;if(opts.filter&&typeof opts.filter==="string"){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter;fetchChanges()})}else{fetchChanges()}function fetchChanges(){txn=idb.transaction([DOC_STORE,BY_SEQ_STORE]);txn.oncomplete=onTxnComplete;var req=descending?txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.seq,true),descending):txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.seq,true));req.onsuccess=onsuccess;req.onerror=onerror}function onsuccess(event){if(!event.target.result){if(opts.continuous&&!opts.cancelled){IdbPouch.Changes.addListener(name,id,opts)}results.map(function(c){if(opts.filter&&!opts.filter.apply(this,[c.doc])){return}if(!opts.include_docs){delete c.doc}call(opts.onChange,c)});return false}var cursor=event.target.result;var index=txn.objectStore(DOC_STORE);index.get(cursor.value._id).onsuccess=function(event){var metadata=event.target.result;if(/_local/.test(metadata.id)){return cursor["continue"]()}var change={id:metadata.id,seq:cursor.key,changes:collectLeaves(metadata.rev_tree),doc:cursor.value,};change.doc._rev=winningRev(metadata.rev_tree[0].pos,metadata.rev_tree[0].ids);if(metadata.deleted){change.deleted=true}if(opts.conflicts){change.doc._conflicts=collectConflicts(metadata.rev_tree)}results=results.filter(function(doc){return doc.id!==change.id});results.push(change);cursor["continue"]()}}function onTxnComplete(){call(opts.complete,null,{results:results})}function onerror(error){if(opts.continuous){IdbPouch.Changes.addListener(name,id,opts)}call(opts.complete)}if(opts.continuous){return{cancel:function(){console.info(name+": Cancel Changes Feed");opts.cancelled=true;IdbPouch.Changes.removeListener(name,id)}}}};api.replicate={};api.replicate.from=function idb_replicate_from(url,opts,callback){if(opts instanceof Function){callback=opts;opts={}}return Pouch.replicate(url,api,opts,callback)};api.replicate.to=function idb_replicate_to(dbName,opts,callback){if(opts instanceof Function){callback=opts;opts={}}return Pouch.replicate(api,dbName,opts,callback)};api.query=function idb_query(fun,opts,callback){if(opts instanceof Function){callback=opts;opts={}}if(callback){opts.complete=callback}if(typeof fun==="string"){var parts=fun.split("/");api.get("_design/"+parts[0],function(err,doc){if(err){call(callback,err)}new viewQuery({map:doc.views[parts[1]].map,reduce:doc.views[parts[1]].reduce},idb,opts)})}else{new viewQuery(fun,idb,opts)}};var yankError=function(callback){return function(err,results){if(err||results[0].error){call(callback,err||results[0])}else{call(callback,null,results[0])}}};var viewQuery=function(fun,idb,options){if(!options.complete){return}function sum(values){return values.reduce(function(a,b){return a+b},0)}var txn=idb.transaction([DOC_STORE,BY_SEQ_STORE],IDBTransaction.READ);var objectStore=txn.objectStore(DOC_STORE);var results=[];var current;var emit=function(key,val){var viewRow={id:current._id,key:key,value:val};if(options.include_docs){viewRow.doc=current.doc}results.push(viewRow)};eval("fun.map = "+fun.map.toString()+";");if(fun.reduce){eval("fun.reduce = "+fun.reduce.toString()+";")}var request=objectStore.openCursor();request.onerror=idbError(options.error);request.onsuccess=fetchMetadata;function viewComplete(){results.sort(function(a,b){return Pouch.collate(a.key,b.key)});if(options.descending){results.reverse()}if(options.reduce===false){return options.complete(null,{rows:results})}var groups=[];results.forEach(function(e){var last=groups[groups.length-1]||null;if(last&&Pouch.collate(last.key[0][0],e.key)===0){last.key.push([e.key,e.id]);last.value.push(e.value);return}groups.push({key:[[e.key,e.id]],value:[e.value]})});groups.forEach(function(e){e.value=fun.reduce(e.key,e.value)||null;e.key=e.key[0][0]});options.complete(null,{rows:groups})}function fetchDocData(cursor,metadata,e){current={doc:e.target.result,metadata:metadata};current.doc._rev=winningRev(current.metadata.rev_tree[0].pos,current.metadata.rev_tree[0].ids);if(options.complete&&!current.metadata.deleted){fun.map.apply(this,[current.doc])}cursor["continue"]()}function fetchMetadata(e){var cursor=e.target.result;if(!cursor){return viewComplete()}var metadata=e.target.result.value;var dataReq=txn.objectStore(BY_SEQ_STORE).get(metadata.seq);dataReq.onsuccess=fetchDocData.bind(this,cursor,metadata);dataReq.onerror=idbError(options.complete)}};function winningRev(pos,tree){if(!tree[1].length){return pos+"-"+tree[0]}return winningRev(pos+1,tree[1][0])}return api};IdbPouch.valid=function idb_valid(){return !!window.indexedDB};IdbPouch.destroy=function idb_destroy(name,callback){console.info(name+": Delete Database");IdbPouch.Changes.clearListeners(name);var req=indexedDB.deleteDatabase(name);req.onsuccess=function(){call(callback,null)};req.onerror=idbError(callback)};IdbPouch.Changes=(function(){var api={};var listeners={};api.addListener=function(db,id,opts){if(!listeners[db]){listeners[db]={}}listeners[db][id]=opts};api.removeListener=function(db,id){delete listeners[db][id]};api.clearListeners=function(db){delete listeners[db]};api.emitChange=function(db,change){if(!listeners[db]){return}for(var i in listeners[db]){var opts=listeners[db][i];if(opts.filter&&!opts.filter.apply(this,[change.doc])){return}if(!opts.include_docs){delete change.doc}opts.onChange.apply(opts.onChange,[change])}};return api})();Pouch.adapter("idb",IdbPouch)})(this);
